<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FROST | VAULT</title>
    
    <link rel="icon" href="https://static.vecteezy.com/system/resources/previews/000/550/805/non_2x/snowflake-vector-icon.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #010103; 
            --primary: #ffffff; 
            --accent: #00f3ff;
            --card: rgba(10, 10, 15, 0.7); 
            --text: #e0e0ff; 
            --red: #ff4444; 
            --blue-new: #0077ff; 
            --admin-bg: #010103;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; transition: all 0.3s ease; }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            min-height: 100vh; 
            padding: 5vh 20px; 
            overflow-x: hidden; 
            cursor: default; 
            -webkit-tap-highlight-color: transparent;
        }

        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

        .container { max-width: 1000px; margin: 0 auto; position: relative; z-index: 2; padding-bottom: 60px; }
        
        header { margin-bottom: 40px; text-align: center; }
        .logo { 
            font-size: 1.5rem; 
            font-weight: 700; 
            letter-spacing: 12px; 
            text-transform: uppercase; 
            color: #fff; 
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3); 
        }

        .fixed-credits {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 0.55rem;
            letter-spacing: 4px;
            text-transform: uppercase;
            opacity: 0.3;
            color: #fff;
            z-index: 1001;
            pointer-events: none;
        }

        .controls-wrapper { display: flex; flex-direction: column; align-items: center; gap: 25px; margin-bottom: 50px; }
        
        .search-container { display: flex; width: 100%; max-width: 500px; gap: 10px; }
        #vaultSearch { 
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            padding: 15px 20px; 
            width: 100%; 
            border-radius: 2px; 
            color: #fff; 
            outline: none; 
            font-size: 0.8rem; 
            letter-spacing: 2px; 
        }
        #vaultSearch:focus { border-color: #fff; background: rgba(255,255,255,0.08); }

        .categories { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .cat-btn { 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 12px 24px; 
            color: rgba(255,255,255,0.6); 
            font-size: 0.65rem; 
            font-weight: 700; 
            letter-spacing: 2px; 
            cursor: pointer; 
            text-transform: uppercase; 
            border-radius: 2px;
        }
        .cat-btn.active { 
            background: #ffffff !important; 
            color: #000000 !important; 
            border-color: #ffffff; 
            box-shadow: 0 0 25px rgba(255,255,255,0.3); 
        }

        #status { display: flex; flex-direction: column; align-items: center; gap: 15px; margin: 50px 0; }
        .spinner { 
            width: 30px; 
            height: 30px; 
            border: 2px solid rgba(255, 255, 255, 0.1); 
            border-top: 2px solid #ffffff; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        
        .card { 
            background: var(--card); 
            padding: 40px 30px; 
            border-radius: 4px; 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            animation: fadeInUp 0.8s ease forwards; 
            opacity: 0; 
            display: block; 
            cursor: pointer; 
            position: relative; 
            backdrop-filter: blur(8px);
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .card:hover { 
            border-color: #ffffff; 
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.1); 
            transform: translateY(-5px); 
            background: rgba(255, 255, 255, 0.05); 
        }
        
        .type-tag { font-size: 0.5rem; letter-spacing: 2px; color: var(--accent); margin-bottom: 10px; display: block; opacity: 0.6; text-transform: uppercase; }
        
        .new-tag { 
            background: var(--blue-new); 
            color: #fff; 
            font-size: 0.55rem; 
            padding: 2px 6px; 
            border-radius: 2px; 
            margin-left: 8px; 
            font-weight: 700;
        }

        .card-title { font-size: 0.85rem; font-weight: 700; margin-bottom: 10px; color: #fff; letter-spacing: 2px; text-transform: uppercase; display: flex; align-items: center; }
        .card-desc { font-size: 0.7rem; color: rgba(224, 224, 255, 0.4); line-height: 1.8; }

        #pageOverlay { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: rgba(1, 1, 3, 0.98); 
            z-index: 5000; display: none; 
            overflow-y: auto; padding: 100px 20px; opacity: 0; transition: opacity 0.5s ease; backdrop-filter: blur(20px);
        }
        #pageOverlay.active { opacity: 1; display: block; }
        
        .close-page { position: fixed; top: 30px; left: 30px; color: #fff; cursor: pointer; font-size: 0.7rem; letter-spacing: 3px; opacity: 0.4; z-index: 5001; }
        .close-page:hover { opacity: 1; }

        .vault-content-container { 
            max-width: 800px; margin: 0 auto; 
            background: rgba(255, 255, 255, 0.02); 
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 60px 40px;
            border-radius: 4px;
        }

        .page-header { text-align: center; margin-bottom: 50px; }
        #pageIcon { 
            width: 70px; height: 70px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 10px; background: rgba(255,255,255,0.03);
            object-fit: contain; margin-bottom: 25px;
        }
        
        #pageType { 
            display: inline-block; padding: 4px 12px; 
            background: rgba(0, 243, 255, 0.1); 
            border: 1px solid var(--accent); 
            color: var(--accent); font-size: 0.6rem; 
            border-radius: 2px; margin-bottom: 15px; 
            text-transform: uppercase; letter-spacing: 1px;
        }

        .settings-box { 
            background: #000; 
            border: 1px solid rgba(255,255,255,0.1);
            padding: 25px; 
            font-family: 'Courier New', monospace; 
            font-size: 0.75rem; 
            color: var(--accent); 
            white-space: pre-wrap; 
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .btn { 
            background: #ffffff; color: #000000; border: none; 
            padding: 18px 45px; font-weight: 700; cursor: pointer; 
            letter-spacing: 3px; text-transform: uppercase; font-size: 0.75rem; 
            display: inline-flex; align-items: center; gap: 10px; border-radius: 2px;
            text-decoration: none; width: 100%; justify-content: center;
        }
        .btn:hover { background: var(--accent); box-shadow: 0 0 20px rgba(0, 243, 255, 0.4); }

        #adminBtn { position: fixed; bottom: 20px; right: 20px; width: 30px; height: 30px; opacity: 0.05; cursor: pointer; z-index: 1000; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 0.7rem; }
        #adminBtn:hover { opacity: 1; }

        #adminPanel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 6000; display: none; overflow: hidden; }

        #loginBox { height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card-wide { width: 100%; max-width: 450px; text-align: center; }

        .admin-dashboard-wrapper { display: flex; height: 100vh; width: 100%; }
        .admin-sidebar { width: 260px; background: #050508; border-right: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; padding: 40px 0; }
        .sidebar-brand { padding: 0 30px 40px; font-size: 0.8rem; letter-spacing: 4px; color: #fff; text-transform: uppercase; font-weight: 700; opacity: 0.5; }
        
        .admin-sidebar-btn { 
            background: transparent; border: none; color: rgba(255, 255, 255, 0.3); padding: 18px 30px; text-align: left; 
            font-size: 0.65rem; letter-spacing: 2px; text-transform: uppercase; font-weight: 700; cursor: pointer; 
        }
        .admin-sidebar-btn.active { color: #fff; background: rgba(255,255,255,0.05); border-left: 3px solid #fff; }

        .admin-content { flex-grow: 1; padding: 60px; overflow-y: auto; }
        .admin-card { max-width: 800px; margin: 0 auto; }
        .admin-title { font-size: 1rem; letter-spacing: 4px; text-transform: uppercase; color: #fff; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }

        .admin-input-group { margin-bottom: 25px; position: relative; }
        .admin-label { display: block; font-size: 0.6rem; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 12px; color: rgba(255,255,255,0.5); font-weight: 700; }

        input, select, textarea { 
            background: #000; 
            border: 1px solid rgba(255,255,255,0.2); 
            padding: 16px; 
            color: #fff; 
            width: 100%; 
            outline: none; 
            font-size: 0.8rem; 
            border-radius: 2px;
            appearance: none;
        }
        input:focus, select:focus, textarea:focus { border-color: #fff; background: #050508; }
        input:disabled, select:disabled { opacity: 0.3; cursor: not-allowed; border-color: rgba(255,255,255,0.05); }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .icon-preview-box {
            position: absolute; right: 10px; top: 38px;
            width: 40px; height: 40px; border: 1px solid rgba(255,255,255,0.1);
            background: #000; display: flex; align-items: center; justify-content: center; padding: 5px;
        }
        #liveIconPreview { width: 100%; height: 100%; object-fit: contain; }

        .manage-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px;
        }
        .del-btn { background: transparent; border: 1px solid rgba(255, 68, 68, 0.3); color: var(--red); padding: 10px 20px; font-size: 0.6rem; cursor: pointer; text-transform: uppercase; font-weight: 700; }
        .del-btn:hover { background: var(--red); color: #fff; }

        #toast { position: fixed; top: 20px; right: 20px; background: #fff; color: #000; padding: 15px 30px; font-size: 0.7rem; font-weight: 700; letter-spacing: 2px; transform: translateX(200%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 9999; }
        #toast.show { transform: translateX(0); }

        @media (max-width: 800px) {
            .admin-dashboard-wrapper { flex-direction: column; }
            .admin-sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 20px 0; }
            .admin-sidebar nav { display: flex; overflow-x: auto; }
            .admin-sidebar-btn { padding: 15px 20px; white-space: nowrap; border-left: none; }
            .admin-content { padding: 30px 15px; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <canvas id="snow-canvas"></canvas>
    <div id="toast">SYSTEM UPDATED</div>
    <div class="fixed-credits">Made by Batates</div>

    <div id="mainUI" class="container">
        <header>
            <div class="logo">Frost | Vault</div>
        </header>

        <div class="controls-wrapper">
            <div class="search-container">
                <input type="text" id="vaultSearch" placeholder="SEARCH ENTRIES..." onkeyup="filterVault()">
            </div>
            <div class="categories">
                <button class="cat-btn active" data-cat="all" onclick="setCategory('all', this)">All Items</button>
                <button class="cat-btn" data-cat="link" onclick="setCategory('link', this)">Links</button>
                <button class="cat-btn" data-cat="modpack" onclick="setCategory('modpack', this)">Modpacks</button>
                <button class="cat-btn" data-cat="page" onclick="setCategory('page', this)">Pages</button>
                <button class="cat-btn" data-cat="file" onclick="setCategory('file', this)">Files</button>
            </div>
        </div>

        <div id="status">
            <div class="spinner"></div>
            <div id="statusText" style="font-size:0.6rem; letter-spacing:4px; opacity:0.4; color:#fff;">SYNCHRONIZING...</div>
        </div>

        <div id="mainGrid" class="grid"></div>
    </div>

    <!-- Overlay UI -->
    <div id="pageOverlay">
        <div class="close-page" onclick="closePage()">‚Üê BACK TO VAULT</div>
        <div class="vault-content-container">
            <div class="page-header">
                <img id="pageIcon" src="" alt="">
                <br>
                <div id="pageType"></div>
                <h1 id="pageTitle" style="letter-spacing:4px; text-transform:uppercase; font-size: 1.4rem; color: #fff; margin-top: 10px;"></h1>
            </div>
            <p id="pageDesc" style="opacity:0.6; line-height:2; margin-bottom:50px; font-size: 0.9rem;"></p>
            <a id="pageLink" href="#" target="_blank" class="btn">ACCESS RESOURCE</a>
            <div id="settingsArea" style="margin-top:60px;">
                <div id="metaTitle" style="font-size:0.6rem; color: #fff; opacity: 0.4; margin-bottom:10px; letter-spacing: 2px; font-weight: 700; text-transform: uppercase;">Technical Metadata</div>
                <div class="settings-box"><code id="pageSettings"></code></div>
            </div>
        </div>
    </div>

    <div id="adminBtn" onclick="toggleAdmin(true)">A</div>

    <!-- Admin Panel UI -->
    <div id="adminPanel">
        <div id="loginBox">
            <div class="login-card-wide">
                <h2 style="font-size:0.8rem; letter-spacing:6px; margin-bottom:10px; color:#fff; text-transform:uppercase;">Authentication</h2>
                <div style="font-size:0.5rem; letter-spacing:3px; opacity:0.2; color:#fff; margin-bottom:40px;">Admin Access Restricted</div>
                <input type="password" id="pass" placeholder="KEY" style="text-align: center; margin-bottom: 20px;">
                <button class="btn" onclick="checkAuth()">ENTER</button>
                <button style="background:none; border:none; color:rgba(255,255,255,0.2); margin-top:30px; font-size: 0.6rem; letter-spacing: 2px; cursor: pointer;" onclick="toggleAdmin(false)">RETURN</button>
            </div>
        </div>
        
        <div id="actions" class="admin-dashboard-wrapper" style="display:none;">
            <aside class="admin-sidebar">
                <div class="sidebar-brand">Frost Admin</div>
                <nav style="flex-grow: 1;">
                    <button class="admin-sidebar-btn active" id="nav-add" onclick="showAdminTab('add')">Add Entry</button>
                    <button class="admin-sidebar-btn" id="nav-manage" onclick="showAdminTab('manage')">Database</button>
                </nav>
                <div class="fixed-credits" style="position:static; margin:0 30px 40px; opacity:0.1;">Made by Batates</div>
                <div style="padding: 0 30px;">
                    <button class="admin-sidebar-btn" style="color: var(--red);" onclick="location.reload()">Logout</button>
                </div>
            </aside>

            <main class="admin-content">
                <div id="tab-add" class="admin-card">
                    <div class="admin-title" id="adminFormTitle">Create New Resource</div>
                    
                    <div id="updateToggle" class="admin-input-group" style="display:none; margin-bottom: 40px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 20px;">
                        <span class="admin-label">Action Mode</span>
                        <div style="display:flex; gap:10px;">
                             <button class="cat-btn active" id="mode-new" onclick="setMode('add')">New Row</button>
                             <button class="cat-btn" id="mode-update" onclick="setMode('update')">Push Update</button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="admin-input-group">
                            <span class="admin-label">Registry Type</span>
                            <select id="newType" onchange="toggleAdminView()">
                                <option value="link">DIRECT LINK</option>
                                <option value="modpack">MODPACK (CHANGELOG)</option>
                                <option value="page">PAGE DETAILS</option>
                                <option value="file">FILE DOWNLOAD</option>
                            </select>
                        </div>
                        <div class="admin-input-group">
                            <span class="admin-label" id="label-title">Title</span>
                            <!-- Hidden Select for Update Mode -->
                            <select id="updateTargetSelect" style="display:none;" onchange="syncUpdateTitle()">
                                <option value="">Select a Modpack...</option>
                            </select>
                            <!-- Visible Input for New Mode -->
                            <input type="text" id="newTitle" placeholder="Resource Name">
                        </div>
                    </div>
                    <div class="admin-input-group">
                        <span class="admin-label">Endpoint URL</span>
                        <input type="text" id="newUrl" placeholder="https://..." oninput="updateIconPreview()">
                    </div>
                    <div class="admin-input-group">
                        <span class="admin-label">Custom Icon (URL)</span>
                        <input type="text" id="newIcon" placeholder="Leave empty for auto-favicon" oninput="updateIconPreview()">
                        <div class="icon-preview-box"><img id="liveIconPreview" src="https://www.google.com/s2/favicons?sz=128&domain=google.com"></div>
                    </div>
                    <div class="admin-input-group">
                        <span class="admin-label">Description</span>
                        <textarea id="newDesc" placeholder="Summary..." style="height:80px;"></textarea>
                    </div>
                    <div class="admin-input-group">
                        <span class="admin-label" id="label-settings">Metadata / Extra Info</span>
                        <textarea id="newSettings" placeholder="JSON or plain text info..." style="height:80px;"></textarea>
                    </div>
                    <button class="btn" id="submitBtn" onclick="handleFormSubmit()">DEPLOY TO VAULT</button>
                </div>

                <div id="tab-manage" class="admin-card" style="display:none;">
                    <div class="admin-title">Resource Registry</div>
                    <div class="admin-input-group">
                        <input type="text" id="adminManageSearch" placeholder="Filter resources..." onkeyup="renderManage()">
                    </div>
                    <div id="manageList"></div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyuOVD0jQgwsROt-GAqqbUC883vJpHsX2VFOBRGpdgHvIkOB-M0Cu7H_e68ybSOhd2Jxw/exec'; 
        const CACHE_KEY = 'frost_vault_cache';
        
        let allLinks = [], particles = [];
        let currentCategory = 'all';
        let isOfflineMode = false;
        let currentActionMode = 'add';
        let mouse = { x: -1000, y: -1000, lastX: 0, lastY: 0, vx: 0, vy: 0 };
        const canvas = document.getElementById('snow-canvas'), ctx = canvas.getContext('2d');

        window.addEventListener('mousemove', e => {
            mouse.vx = e.clientX - mouse.lastX; mouse.vy = e.clientY - mouse.lastY;
            mouse.lastX = e.clientX; mouse.lastY = e.clientY;
            mouse.x = e.clientX; mouse.y = e.clientY;
        });

        window.onresize = () => { initSnow(); };

        function initSnow() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            particles = [];
            const configs = [
                { count: 40, size: [1.5, 2.5], speed: [1.2, 2.2], op: [0.3, 0.5] },
                { count: 100, size: [0.5, 1.2], speed: [0.5, 1.0], op: [0.1, 0.3] }
            ];
            configs.forEach(c => {
                for(let i=0; i<c.count; i++){
                    let p = new Snow(c);
                    p.y = Math.random() * canvas.height;
                    particles.push(p);
                }
            });
        }

        class Snow {
            constructor(c) { this.c = c; this.reset(); this.swing = Math.random() * 100; this.velX = 0; this.velY = 0; }
            reset() {
                this.x = Math.random() * canvas.width; this.y = -20;
                this.r = Math.random() * (this.c.size[1]-this.c.size[0]) + this.c.size[0];
                this.sy = Math.random() * (this.c.speed[1]-this.c.speed[0]) + this.c.speed[0];
                this.opacity = Math.random() * (this.c.op[1]-this.c.op[0]) + this.c.op[0];
            }
            update() {
                this.swing += 0.01;
                let drift = Math.sin(this.swing) * 0.4;
                let dx = this.x - mouse.x, dy = this.y - mouse.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < 100) {
                    let force = (100 - dist)/100;
                    this.velX += (dx/dist) * force * 0.4 + (mouse.vx * 0.1 * force);
                    this.velY += (dy/dist) * force * 0.4 + (mouse.vy * 0.1 * force);
                }
                this.velX *= 0.92; this.velY *= 0.92;
                this.x += drift + this.velX; this.y += this.sy + this.velY;
                if(this.y > canvas.height + 10) this.reset();
                if(this.x > canvas.width + 10) this.x = -5; if(this.x < -10) this.x = canvas.width + 5;
            }
            draw() { ctx.fillStyle = `rgba(255,255,255,${this.opacity})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.fill(); }
        }

        function animate() { ctx.clearRect(0,0,canvas.width,canvas.height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animate); }

        async function loadVault() {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) { allLinks = JSON.parse(cached); document.getElementById('status').style.display = 'none'; filterVault(); }
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                allLinks = data; localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                isOfflineMode = false; document.getElementById('status').style.display = 'none'; filterVault(); 
                populateUpdateMenu();
            } catch (e) { 
                isOfflineMode = true;
                if(allLinks.length > 0) {
                    const st = document.getElementById('statusText');
                    st.innerText = "OFFLINE CACHE ACTIVE"; st.classList.add('offline-warning');
                }
                setTimeout(loadVault, 10000);
            }
        }

        function populateUpdateMenu() {
            const select = document.getElementById('updateTargetSelect');
            const modpacks = allLinks.filter(l => l.type === 'modpack');
            select.innerHTML = '<option value="">Select a Modpack...</option>' + 
                modpacks.map(m => `<option value="${m.title}">${m.title}</option>`).join('');
        }

        function syncUpdateTitle() {
            const select = document.getElementById('updateTargetSelect');
            const titleInput = document.getElementById('newTitle');
            titleInput.value = select.value;
            
            // Auto-fill existing description and URL if possible to facilitate checking
            const existing = allLinks.find(l => l.title === select.value);
            if(existing) {
                document.getElementById('newUrl').value = existing.url;
                document.getElementById('newDesc').value = existing.desc;
            }
        }

        function isNew(ts) {
            if(!ts) return false;
            return (new Date() - new Date(ts)) / 3600000 <= 24;
        }

        function renderItems(links) {
            document.getElementById('mainGrid').innerHTML = links.map(l => `
                <div class="card" onclick="handleCardClick('${encodeURIComponent(l.url)}')">
                    <span class="type-tag">${l.type}</span>
                    <div class="card-title">${l.title} ${isNew(l.timestamp) ? '<span class="new-tag">NEW</span>' : ''}</div>
                    <p class="card-desc">${l.desc || 'No description available.'}</p>
                </div>
            `).join('');
        }

        function filterVault() {
            const q = document.getElementById('vaultSearch').value.toLowerCase();
            const filtered = allLinks.filter(l => (currentCategory === 'all' || l.type === currentCategory) && l.title.toLowerCase().includes(q));
            renderItems(filtered);
        }

        function setCategory(type, btn) {
            currentCategory = type;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); filterVault();
        }

        function handleCardClick(urlParam) {
            const url = decodeURIComponent(urlParam);
            const item = allLinks.find(l => l.url === url);
            if(!item) return;
            if(item.type === 'link') { window.open(item.url, '_blank'); } else {
                const overlay = document.getElementById('pageOverlay');
                document.getElementById('pageTitle').innerText = item.title;
                document.getElementById('pageDesc').innerText = item.desc;
                document.getElementById('pageType').innerText = item.type;
                document.getElementById('pageLink').href = item.url;
                document.getElementById('pageLink').innerText = (item.type === 'file' || item.type === 'modpack') ? 'DOWNLOAD RESOURCE' : 'OPEN PAGE';
                
                const sArea = document.getElementById('settingsArea');
                const sLabel = document.getElementById('metaTitle');
                if (item.type === 'modpack') {
                    sLabel.innerText = "Changelog / Versions";
                } else {
                    sLabel.innerText = "Technical Metadata";
                }

                if (item.settings?.trim()) { 
                    document.getElementById('pageSettings').innerText = item.settings; 
                    sArea.style.display = 'block'; 
                } else { 
                    sArea.style.display = 'none'; 
                }
                
                const domain = item.url.includes('http') ? new URL(item.url).hostname : 'google.com';
                document.getElementById('pageIcon').src = item.icon || `https://www.google.com/s2/favicons?sz=128&domain=${domain}`;
                overlay.style.display = 'block'; setTimeout(() => overlay.classList.add('active'), 10);
                document.body.style.overflow = 'hidden';
            }
        }

        function closePage() {
            const overlay = document.getElementById('pageOverlay');
            overlay.classList.remove('active'); setTimeout(() => { overlay.style.display = 'none'; }, 500);
            document.body.style.overflow = 'auto';
        }

        function toggleAdmin(s) { 
            if(s && isOfflineMode) return showToast("OFFLINE MODE"); 
            document.getElementById('adminPanel').style.display = s ? 'block' : 'none'; 
        }

        function checkAuth() { 
            if(document.getElementById('pass').value === "YM2012") { 
                document.getElementById('loginBox').style.display = 'none'; 
                document.getElementById('actions').style.display = 'flex'; 
                showAdminTab('add'); 
            } else { showToast("ACCESS DENIED"); } 
        }

        function toggleAdminView() {
            const type = document.getElementById('newType').value;
            const updateToggle = document.getElementById('updateToggle');
            const setLabel = document.getElementById('label-settings');
            
            if (type === 'modpack') {
                updateToggle.style.display = 'block';
                setLabel.innerText = "Changelog Entry";
            } else {
                updateToggle.style.display = 'none';
                setLabel.innerText = "Metadata / Extra Info";
                setMode('add');
            }
        }

        function setMode(mode) {
            currentActionMode = mode;
            document.getElementById('mode-new').classList.toggle('active', mode === 'add');
            document.getElementById('mode-update').classList.toggle('active', mode === 'update');
            document.getElementById('submitBtn').innerText = mode === 'update' ? "PUSH UPDATE" : "DEPLOY TO VAULT";
            
            const titleInput = document.getElementById('newTitle');
            const titleSelect = document.getElementById('updateTargetSelect');
            const labelTitle = document.getElementById('label-title');
            
            const urlInput = document.getElementById('newUrl');
            const descInput = document.getElementById('newDesc');
            const iconInput = document.getElementById('newIcon');
            const settingsInput = document.getElementById('newSettings');

            if (mode === 'update') {
                titleInput.style.display = 'none';
                titleSelect.style.display = 'block';
                labelTitle.innerText = "Target Modpack";
                
                // Allow URL update during push update because URLs change with versions
                urlInput.placeholder = "Enter NEW Modpack URL...";
                descInput.disabled = true;
                iconInput.disabled = true;
                settingsInput.placeholder = "Enter what's new in this version (will be appended)...";
                
                populateUpdateMenu();
            } else {
                titleInput.style.display = 'block';
                titleSelect.style.display = 'none';
                labelTitle.innerText = "Title";
                
                urlInput.disabled = false;
                descInput.disabled = false;
                iconInput.disabled = false;
                urlInput.placeholder = "https://...";
                settingsInput.placeholder = "JSON or plain text info...";
            }
        }

        function updateIconPreview() {
            const icon = document.getElementById('newIcon').value;
            const url = document.getElementById('newUrl').value;
            const preview = document.getElementById('liveIconPreview');
            if(icon) preview.src = icon;
            else if(url) { try { preview.src = `https://www.google.com/s2/favicons?sz=128&domain=${new URL(url).hostname}`; } catch(e){} }
        }

        function showAdminTab(t) {
            document.getElementById('tab-add').style.display = t === 'add' ? 'block' : 'none';
            document.getElementById('tab-manage').style.display = t === 'manage' ? 'block' : 'none';
            document.getElementById('nav-add').classList.toggle('active', t === 'add');
            document.getElementById('nav-manage').classList.toggle('active', t === 'manage');
            if(t === 'manage') renderManage();
        }

        function renderManage() {
            const q = document.getElementById('adminManageSearch').value.toLowerCase();
            const filtered = allLinks.filter(l => l.title.toLowerCase().includes(q));
            document.getElementById('manageList').innerHTML = filtered.map(l => `
                <div class="manage-item">
                    <div><div style="font-weight:700; font-size:0.7rem;">${l.title}</div><div style="font-size:0.5rem; opacity:0.5;">${l.type}</div></div>
                    <button class="del-btn" onclick="sendToSheet('delete', '${l.title}', '${l.url}')">REMOVE</button>
                </div>
            `).join('');
        }

        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }

        function handleFormSubmit() {
            const title = document.getElementById('newTitle').value;
            if(!title) return showToast("TITLE REQUIRED");
            
            if(currentActionMode === 'add' && !document.getElementById('newUrl').value) return showToast("URL REQUIRED");
            
            sendToSheet(currentActionMode);
        }

        async function sendToSheet(action, titleOverride, urlOverride) {
            showToast("PROCESSING...");
            
            // For update action, use the title to find the row in the sheet
            const payload = {
                action: action,
                title: titleOverride || document.getElementById('newTitle').value, 
                url: urlOverride || document.getElementById('newUrl').value,
                icon: document.getElementById('newIcon').value, 
                desc: document.getElementById('newDesc').value,
                type: document.getElementById('newType').value, 
                settings: document.getElementById('newSettings').value,
                timestamp: new Date().toISOString()
            };

            try {
                await fetch(API_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) 
                });
                showToast("COMPLETE"); 
                localStorage.removeItem(CACHE_KEY);
                setTimeout(() => location.reload(), 1500);
            } catch(e) { 
                showToast("NETWORK ERROR"); 
            }
        }

        initSnow(); animate(); loadVault();
    </script>
</body>
</html>
