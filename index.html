<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FROST | VAULT</title>
    
    <link rel="icon" href="https://static.vecteezy.com/system/resources/previews/000/550/805/non_2x/snowflake-vector-icon.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #010103; 
            --primary: #ffffff; 
            --accent: #00f3ff;
            --card: rgba(10, 10, 15, 0.7); 
            --text: #e0e0ff; 
            --red: #ff4444; 
            --blue-new: #0077ff; 
            --admin-bg: rgba(2, 2, 5, 0.98);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; transition: all 0.3s ease; }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            min-height: 100vh; 
            padding: 5vh 20px; 
            overflow-x: hidden; 
            cursor: default; 
        }

        /* Background Canvas */
        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

        .container { max-width: 1000px; margin: 0 auto; position: relative; z-index: 2; padding-bottom: 60px; }
        
        header { margin-bottom: 40px; text-align: center; }
        .logo { 
            font-size: 1.5rem; 
            font-weight: 700; 
            letter-spacing: 12px; 
            text-transform: uppercase; 
            color: #fff; 
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3); 
        }

        /* Controls */
        .controls-wrapper { display: flex; flex-direction: column; align-items: center; gap: 25px; margin-bottom: 50px; }
        
        .search-container { display: flex; width: 100%; max-width: 500px; gap: 10px; }
        #vaultSearch { 
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid rgba(255, 255, 255, 1); 
            padding: 15px 20px; 
            width: 100%; 
            border-radius: 0px; 
            color: #fff; 
            outline: none; 
            font-size: 0.8rem; 
            letter-spacing: 2px; 
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.05);
        }

        .categories { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .cat-btn { 
            background: rgba(255, 255, 255, 0.08); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            padding: 10px 22px; 
            color: #fff; 
            font-size: 0.65rem; 
            font-weight: 700; 
            letter-spacing: 2px; 
            cursor: pointer; 
            text-transform: uppercase; 
            border-radius: 2px;
        }
        .cat-btn.active { 
            background: #ffffff !important; 
            color: #000000 !important; 
            border-color: #ffffff; 
            box-shadow: 0 0 25px rgba(255,255,255,0.4); 
        }

        /* Loading State */
        #status { display: flex; flex-direction: column; align-items: center; gap: 15px; margin: 50px 0; }
        .spinner { 
            width: 30px; 
            height: 30px; 
            border: 2px solid rgba(255, 255, 255, 0.1); 
            border-top: 2px solid #ffffff; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Grid System */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        
        .card { 
            background: var(--card); 
            padding: 40px 30px; 
            border-radius: 4px; 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            text-decoration: none; 
            color: inherit; 
            animation: fadeInUp 0.8s ease forwards; 
            opacity: 0; 
            display: block; 
            cursor: pointer; 
            position: relative; 
            backdrop-filter: blur(8px);
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .card:hover { 
            border-color: #ffffff; 
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.15); 
            transform: translateY(-5px); 
            background: rgba(13, 13, 20, 0.8); 
        }
        
        .type-tag { font-size: 0.5rem; letter-spacing: 2px; color: var(--accent); margin-bottom: 10px; display: block; opacity: 0.6; text-transform: uppercase; }
        
        .new-tag { 
            background: var(--blue-new); 
            color: #fff; 
            font-size: 0.55rem; 
            padding: 2px 6px; 
            border-radius: 2px; 
            margin-left: 8px; 
            font-weight: 700;
            letter-spacing: 1px;
        }

        .card-title { font-size: 0.85rem; font-weight: 700; margin-bottom: 10px; color: #fff; letter-spacing: 2px; text-transform: uppercase; display: flex; align-items: center; flex-wrap: wrap; }
        .card-desc { font-size: 0.7rem; color: rgba(224, 224, 255, 0.4); line-height: 1.8; }

        /* Enhanced Page Overlay */
        #pageOverlay { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: radial-gradient(circle at 50% 50%, rgba(5, 5, 15, 0.98) 0%, rgba(1, 1, 3, 1) 100%); 
            z-index: 5000; display: none; 
            overflow-y: auto; padding: 100px 20px; opacity: 0; transition: opacity 0.6s ease; backdrop-filter: blur(25px);
        }
        #pageOverlay.active { opacity: 1; display: block; }
        
        .close-page { position: fixed; top: 30px; left: 30px; color: var(--text); cursor: pointer; font-size: 0.7rem; letter-spacing: 3px; opacity: 0.4; z-index: 5001; }
        .close-page:hover { opacity: 1; color: #fff; }

        .vault-content-container { 
            max-width: 800px; margin: 0 auto; 
            background: rgba(255, 255, 255, 0.02); 
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 60px 40px;
            border-radius: 8px;
        }

        .page-header { text-align: center; margin-bottom: 50px; }
        #pageIcon { 
            width: 80px; height: 80px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 10px; background: rgba(0,0,0,0.3);
            object-fit: contain; margin-bottom: 25px;
        }
        
        #pageType { 
            display: inline-block; padding: 4px 12px; 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: #fff; font-size: 0.6rem; 
            border-radius: 20px; margin-bottom: 15px; 
            text-transform: uppercase;
        }

        .settings-box { 
            background: #050508; 
            border-left: 2px solid var(--accent); 
            padding: 25px; 
            font-family: 'Courier New', Courier, monospace; 
            font-size: 0.75rem; 
            color: #b0fbff; 
            white-space: pre-wrap; 
            margin-top: 15px;
            overflow-x: auto;
        }
        
        .btn { 
            background: #ffffff; color: #000000; border: none; 
            padding: 18px 45px; font-weight: 700; cursor: pointer; 
            letter-spacing: 3px; text-transform: uppercase; font-size: 0.75rem; 
            display: inline-flex; align-items: center; gap: 10px; border-radius: 0px;
            text-decoration: none; width: 100%; justify-content: center;
        }
        .btn:hover { background: var(--accent); }

        /* Admin Trigger */
        #adminBtn { 
            position: fixed; bottom: 20px; right: 20px; 
            width: 30px; height: 30px; opacity: 0.1; 
            cursor: pointer; z-index: 1000; 
            display: flex; align-items: center; justify-content: center; 
            color: #fff; font-size: 0.7rem; font-weight: 200;
        }
        #adminBtn:hover { opacity: 1; }

        /* Admin Panel */
        #adminPanel { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--admin-bg); 
            z-index: 6000; display: none; padding: 0; 
            overflow-y: auto; backdrop-filter: blur(40px);
        }
        
        .admin-nav {
            display: flex; justify-content: center; gap: 20px;
            padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05);
            background: rgba(0,0,0,0.4); margin-bottom: 40px;
        }
        
        .admin-nav-btn {
            background: none; border: none; color: rgba(255,255,255,0.3);
            font-size: 0.65rem; letter-spacing: 2px; text-transform: uppercase;
            font-weight: 700; cursor: pointer; padding: 10px;
        }
        .admin-nav-btn.active { color: #fff; border-bottom: 2px solid #fff; }

        .admin-section { 
            background: rgba(255,255,255,0.02); padding: 40px; 
            border: 1px solid rgba(255,255,255,0.05); 
            max-width: 700px; margin: 0 auto 40px; border-radius: 4px;
        }

        .admin-input-group { margin-bottom: 20px; position: relative; }
        .admin-label {
            display: block; font-size: 0.55rem; letter-spacing: 2px;
            text-transform: uppercase; margin-bottom: 8px; color: rgba(255,255,255,0.4);
        }

        input, select, textarea { 
            background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 14px; color: #fff; width: 100%; outline: none; font-size: 0.8rem; 
        }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); }

        .icon-preview-box {
            position: absolute; right: 0px; top: 32px;
            width: 80px; height: 80px; border: 1px solid rgba(255,255,255,0.15);
            background: rgba(0,0,0,0.6); display: flex; align-items: center;
            justify-content: center; padding: 10px; z-index: 5;
            backdrop-filter: blur(5px);
        }
        #liveIconPreview { width: 100%; height: 100%; object-fit: contain; }

        .manage-item {
            display: grid; grid-template-columns: 1fr auto; align-items: center;
            padding: 15px 20px; background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; gap: 15px;
        }
        .manage-item-title { font-size: 0.75rem; font-weight: 700; color: #fff; text-transform: uppercase; }
        .manage-item-meta { font-size: 0.55rem; opacity: 0.4; text-transform: uppercase; }
        
        .del-btn {
            background: none; border: 1px solid rgba(255, 68, 68, 0.3);
            color: var(--red); padding: 8px 15px; font-size: 0.6rem;
            cursor: pointer; letter-spacing: 1px; font-weight: 700; text-transform: uppercase;
        }
        .del-btn:hover { background: var(--red); color: #fff; }

        #toast { position: fixed; top: 20px; right: 20px; background: #fff; color: #000; padding: 15px 30px; font-size: 0.7rem; font-weight: 700; letter-spacing: 2px; transform: translateX(200%); transition: transform 0.5s ease; z-index: 9999; }
        #toast.show { transform: translateX(0); }

        .credit-tag { position: fixed; bottom: 20px; left: 20px; font-size: 0.6rem; letter-spacing: 4px; opacity: 0.2; text-transform: uppercase; z-index: 1; }

        @media (max-width: 600px) {
            .logo { font-size: 1rem; letter-spacing: 6px; }
            #pageOverlay { padding: 60px 15px; }
            .vault-content-container { padding: 30px 15px; }
            .icon-preview-box { position: relative; top: 0; width: 60px; height: 60px; margin-top: 10px; }
        }
    </style>
</head>
<body>

    <canvas id="snow-canvas"></canvas>
    <div id="toast">SYSTEM UPDATED</div>

    <div id="mainUI" class="container">
        <header><div class="logo">Frost | Vault</div></header>

        <div class="controls-wrapper">
            <div class="search-container">
                <input type="text" id="vaultSearch" placeholder="SEARCH ENTRIES..." onkeyup="filterVault()">
            </div>
            <div class="categories">
                <button class="cat-btn active" data-cat="all" onclick="setCategory('all', this)">All Items</button>
                <button class="cat-btn" data-cat="link" onclick="setCategory('link', this)">Links</button>
                <button class="cat-btn" data-cat="page" onclick="setCategory('page', this)">Pages</button>
                <button class="cat-btn" data-cat="file" onclick="setCategory('file', this)">Files</button>
            </div>
        </div>

        <div id="status">
            <div class="spinner"></div>
            <div style="font-size:0.6rem; letter-spacing:4px; opacity:0.4; color:#fff;">LOADING REGISTRY...</div>
        </div>

        <div id="mainGrid" class="grid"></div>
    </div>

    <div class="credit-tag">MADE BY BATATES</div>

    <!-- Details Overlay -->
    <div id="pageOverlay">
        <div class="close-page" onclick="closePage()">‚Üê BACK TO LIST</div>
        <div class="vault-content-container">
            <div class="page-header">
                <img id="pageIcon" src="" alt="">
                <br>
                <div id="pageType"></div>
                <h1 id="pageTitle" style="letter-spacing:4px; text-transform:uppercase; font-size: 1.4rem; color: #fff; margin-top: 10px;"></h1>
            </div>
            
            <p id="pageDesc" style="opacity:0.6; line-height:2; margin-bottom:50px; font-size: 0.9rem; text-align: left;"></p>
            
            <a id="pageLink" href="#" target="_blank" class="btn">VISIT SITE</a>
            
            <div id="settingsArea" style="margin-top:60px;">
                <div style="font-size:0.6rem; color: var(--accent); margin-bottom:10px; letter-spacing: 2px; font-weight: 700; text-transform: uppercase;">
                    Additional Data
                </div>
                <div class="settings-box"><code id="pageSettings"></code></div>
            </div>
        </div>
    </div>

    <!-- Admin Trigger -->
    <div id="adminBtn" onclick="toggleAdmin(true)">A</div>

    <!-- Admin Panel -->
    <div id="adminPanel">
        <div id="loginBox" style="height: 100vh; display: flex; align-items: center; justify-content: center;">
            <div class="admin-section" style="width: 100%; max-width: 450px;">
                <h2 style="font-size:0.75rem; letter-spacing:4px; margin-bottom:30px; text-align:center; color:#fff; text-transform:uppercase;">Admin Login</h2>
                <div class="admin-input-group">
                    <span class="admin-label">Password</span>
                    <input type="password" id="pass" placeholder="Enter key" style="text-align: center;">
                </div>
                <button class="btn" onclick="checkAuth()">LOGIN</button>
                <button class="btn" style="background:none; color:rgba(255,255,255,0.3); margin-top:10px;" onclick="toggleAdmin(false)">CANCEL</button>
            </div>
        </div>
        
        <div id="actions" style="display:none;">
            <div class="admin-nav">
                <button class="admin-nav-btn active" id="nav-add" onclick="showAdminTab('add')">Add Entry</button>
                <button class="admin-nav-btn" id="nav-manage" onclick="showAdminTab('manage')">Manage Entries</button>
                <button class="admin-nav-btn" onclick="location.reload()">Logout</button>
            </div>

            <div id="tab-add" class="admin-section">
                <h3 style="font-size:0.7rem; letter-spacing:2px; margin-bottom:25px; color:#fff; text-transform:uppercase;">New Entry</h3>
                
                <div class="admin-input-group">
                    <span class="admin-label">Entry Type</span>
                    <select id="newType">
                        <option value="link">DIRECT LINK</option>
                        <option value="page">PAGE DETAILS</option>
                        <option value="file">FILE DOWNLOAD</option>
                    </select>
                </div>

                <div class="admin-input-group">
                    <span class="admin-label">Title</span>
                    <input type="text" id="newTitle" placeholder="Entry name">
                </div>

                <div class="admin-input-group" style="padding-right: 90px;">
                    <span class="admin-label">URL</span>
                    <input type="text" id="newUrl" placeholder="https://example.com" oninput="updateIconPreview()">
                </div>
                
                <div class="admin-input-group" style="padding-right: 90px;">
                    <span class="admin-label">Icon Image URL (Optional)</span>
                    <input type="text" id="newIcon" placeholder="Specific image URL" oninput="updateIconPreview()">
                    <div class="icon-preview-box">
                        <img id="liveIconPreview" src="https://www.google.com/s2/favicons?sz=128&domain=google.com" alt="">
                    </div>
                </div>

                <div class="admin-input-group">
                    <span class="admin-label">Description</span>
                    <textarea id="newDesc" placeholder="Brief summary of the entry..." style="height:80px;"></textarea>
                </div>

                <div class="admin-input-group">
                    <span class="admin-label">Extra Info (Visible on Pages)</span>
                    <textarea id="newSettings" placeholder="Additional details..." style="height:80px;"></textarea>
                </div>

                <button class="btn" onclick="sendToSheet('add')">SAVE TO VAULT</button>
            </div>

            <div id="tab-manage" class="admin-section">
                <h3 style="font-size:0.7rem; letter-spacing:2px; margin-bottom:20px; color:#fff; text-transform:uppercase;">Manage Vault</h3>
                
                <div class="admin-input-group">
                    <span class="admin-label">Search Current Items</span>
                    <input type="text" id="adminManageSearch" placeholder="Type name..." onkeyup="renderManage()">
                </div>

                <div id="manageList"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxfuZSmIsEmP5rcj8XrQcdagyCP4j0BvHynZi6mZEs9MvnbroUBClsYHIt_-XPKMvE26w/exec'; 
        
        let allLinks = [], particles = [];
        let currentCategory = 'all';
        let mouse = { x: -1000, y: -1000, lastX: 0, lastY: 0, vx: 0, vy: 0 };
        const canvas = document.getElementById('snow-canvas'), ctx = canvas.getContext('2d');

        window.addEventListener('mousemove', e => {
            mouse.vx = e.clientX - mouse.lastX; 
            mouse.vy = e.clientY - mouse.lastY;
            mouse.lastX = e.clientX; 
            mouse.lastY = e.clientY;
            mouse.x = e.clientX; 
            mouse.y = e.clientY;
        });

        function initSnow() {
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight;
            particles = [];
            
            // Triple-layer parallax snow
            const layerConfigs = [
                { count: 40, size: [1.5, 2.5], speed: [1.5, 2.5], op: [0.3, 0.5] }, // Front (large/fast)
                { count: 60, size: [0.8, 1.4], speed: [0.8, 1.2], op: [0.2, 0.4] }, // Mid
                { count: 80, size: [0.3, 0.7], speed: [0.3, 0.6], op: [0.1, 0.2] }  // Back (tiny/slow)
            ];

            layerConfigs.forEach(layer => {
                for(let i=0; i < layer.count; i++) {
                    let p = new Snow(layer);
                    p.y = Math.random() * canvas.height;
                    particles.push(p);
                }
            });
        }

        class Snow {
            constructor(config) { 
                this.config = config;
                this.reset(); 
                this.velX = 0; 
                this.velY = 0; 
                this.swing = Math.random() * 100;
            }
            reset() { 
                this.x = Math.random() * canvas.width; 
                this.y = -20; 
                this.r = Math.random() * (this.config.size[1] - this.config.size[0]) + this.config.size[0]; 
                this.sx = (Math.random() - 0.5) * 0.2; 
                this.sy = Math.random() * (this.config.speed[1] - this.config.speed[0]) + this.config.speed[0]; 
                this.opacity = Math.random() * (this.config.op[1] - this.config.op[0]) + this.config.op[0];
            }
            update() {
                this.swing += 0.02;
                let drift = Math.sin(this.swing) * 0.3;

                let dx = this.x - mouse.x;
                let dy = this.y - mouse.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < 100) { 
                    let force = (100 - dist) / 100; 
                    this.velX += (dx/dist) * force * 0.3 + (mouse.vx * 0.08 * force); 
                    this.velY += (dy/dist) * force * 0.3 + (mouse.vy * 0.08 * force); 
                }
                
                this.velX *= 0.94; 
                this.velY *= 0.94;
                this.x += this.sx + this.velX + drift; 
                this.y += this.sy + this.velY;
                
                if(this.y > canvas.height + 10) this.reset();
                if(this.x > canvas.width + 10) this.x = -5;
                if(this.x < -10) this.x = canvas.width + 5;
            }
            draw() { 
                ctx.fillStyle = `rgba(255,255,255,${this.opacity})`;
                ctx.beginPath(); 
                ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); 
                ctx.fill(); 
            }
        }

        function animate() {
            ctx.clearRect(0,0,canvas.width,canvas.height); 
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }

        async function loadVault() {
            try {
                const res = await fetch(API_URL); 
                allLinks = await res.json();
                document.getElementById('status').style.display = 'none';
                filterVault(); 
            } catch (e) { 
                setTimeout(loadVault, 3000); 
            }
        }

        function isNew(ts) {
            if (!ts) return false;
            const diff = (new Date() - new Date(ts)) / (1000 * 60 * 60);
            return diff <= 24 && diff >= 0; 
        }

        function renderItems(links) {
            document.getElementById('mainGrid').innerHTML = links.map((l) => {
                const safeUrl = encodeURIComponent(l.url);
                const showNew = isNew(l.timestamp) ? `<span class="new-tag">NEW</span>` : '';
                return `
                    <div class="card" onclick="handleCardClick('${safeUrl}')">
                        <span class="type-tag">${l.type}</span>
                        <div class="card-title">${l.title} ${showNew}</div>
                        <p class="card-desc">${l.desc || '...'}</p>
                    </div>`;
            }).join('');
        }

        function filterVault() {
            const query = document.getElementById('vaultSearch').value.toLowerCase();
            const filtered = allLinks.filter(item => {
                const matchesCategory = (currentCategory === 'all' || item.type === currentCategory);
                return matchesCategory && item.title.toLowerCase().includes(query);
            });
            renderItems(filtered);
        }

        function setCategory(type, btn) {
            currentCategory = type;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filterVault();
        }

        function handleCardClick(urlParam) {
            const targetUrl = decodeURIComponent(urlParam);
            const item = allLinks.find(l => l.url === targetUrl);
            if(!item) return;

            if(item.type === 'link') { 
                window.open(item.url, '_blank'); 
            } else {
                const overlay = document.getElementById('pageOverlay');
                document.getElementById('pageTitle').innerText = item.title;
                document.getElementById('pageDesc').innerText = item.desc;
                document.getElementById('pageType').innerText = item.type;
                document.getElementById('pageLink').href = item.url;
                
                document.getElementById('pageLink').innerText = item.type === 'file' ? 'DOWNLOAD' : 'VISIT SITE';

                const sArea = document.getElementById('settingsArea');
                if (item.settings && item.settings.trim() !== "") { 
                    document.getElementById('pageSettings').innerText = item.settings; 
                    sArea.style.display = 'block'; 
                } else { sArea.style.display = 'none'; }
                
                if (item.icon) document.getElementById('pageIcon').src = item.icon;
                else {
                    try {
                        const domain = new URL(item.url).hostname;
                        document.getElementById('pageIcon').src = `https://www.google.com/s2/favicons?sz=128&domain=${domain}`;
                    } catch(e) { document.getElementById('pageIcon').src = 'https://www.google.com/s2/favicons?sz=128&domain=google.com'; }
                }

                overlay.style.display = 'block';
                setTimeout(() => overlay.classList.add('active'), 10);
                document.body.style.overflow = 'hidden';
            }
        }

        function closePage() {
            const overlay = document.getElementById('pageOverlay');
            overlay.classList.remove('active'); 
            setTimeout(() => { overlay.style.display = 'none'; }, 600);
            document.body.style.overflow = 'auto';
        }

        function toggleAdmin(s) { 
            document.getElementById('adminPanel').style.display = s ? 'block' : 'none'; 
            if(!s) document.getElementById('pass').value = '';
        }

        function checkAuth() { 
            if(document.getElementById('pass').value === "YM2012") { 
                document.getElementById('loginBox').style.display = 'none'; 
                document.getElementById('actions').style.display = 'block'; 
                showAdminTab('add');
            } else { showToast("INCORRECT KEY"); }
        }

        function updateIconPreview() {
            const customIcon = document.getElementById('newIcon').value;
            const targetUrl = document.getElementById('newUrl').value;
            const preview = document.getElementById('liveIconPreview');

            if (customIcon) {
                preview.src = customIcon;
            } else if (targetUrl) {
                try {
                    const domain = new URL(targetUrl).hostname;
                    preview.src = `https://www.google.com/s2/favicons?sz=128&domain=${domain}`;
                } catch (e) {
                    preview.src = 'https://www.google.com/s2/favicons?sz=128&domain=google.com';
                }
            }
        }

        function showAdminTab(tab) {
            document.getElementById('tab-add').style.display = tab === 'add' ? 'block' : 'none';
            document.getElementById('tab-manage').style.display = tab === 'manage' ? 'block' : 'none';
            document.getElementById('nav-add').classList.toggle('active', tab === 'add');
            document.getElementById('nav-manage').classList.toggle('active', tab === 'manage');
            if(tab === 'manage') renderManage();
        }

        function renderManage() { 
            const q = document.getElementById('adminManageSearch').value.toLowerCase();
            const filtered = allLinks.filter(l => l.title.toLowerCase().includes(q));
            
            document.getElementById('manageList').innerHTML = filtered.map(l => `
                <div class="manage-item">
                    <div>
                        <div class="manage-item-title">${l.title}</div>
                        <div class="manage-item-meta">${l.type}</div>
                    </div>
                    <button class="del-btn" onclick="sendToSheet('delete', '${l.title}', '${l.url}')">REMOVE</button>
                </div>`).join(''); 
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        async function sendToSheet(action, title, url) { 
            showToast("COMMUNICATING...");
            const payload = action === 'add' ? { 
                title: document.getElementById('newTitle').value, 
                url: document.getElementById('newUrl').value, 
                icon: document.getElementById('newIcon').value, 
                desc: document.getElementById('newDesc').value, 
                type: document.getElementById('newType').value, 
                settings: document.getElementById('newSettings').value, 
                timestamp: new Date().toISOString(), 
                action: 'add' 
            } : { title, url, action: 'delete' }; 

            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) }); 
                showToast("SUCCESS");
                setTimeout(() => location.reload(), 1500);
            } catch (e) { showToast("ERROR"); }
        }

        window.onresize = initSnow; initSnow(); animate(); loadVault();
    </script>
</body>
</html>
